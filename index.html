<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SparkyBot Command Center</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            surface: { 50: '#1a1a2e', 100: '#16213e', 200: '#0f3460', 300: '#252547' },
            amber: { 400: '#f6b93b', 500: '#e58e26', 600: '#d4a017' },
            slate: { 750: '#293548' }
          },
          fontFamily: {
            mono: ['JetBrains Mono', 'monospace'],
            sans: ['DM Sans', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    body { background: #0a0a1a; color: #e2e8f0; font-family: 'DM Sans', sans-serif; margin: 0; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }

    .kanban-column { min-height: calc(100vh - 220px); }
    .card-drag { opacity: 0.5; }
    .drop-target { border: 2px dashed #f6b93b !important; background: rgba(246, 185, 59, 0.05) !important; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-16px); } to { opacity: 1; transform: translateX(0); } }
    .animate-fade { animation: fadeIn 0.3s ease-out; }
    .animate-slide { animation: slideIn 0.25s ease-out; }
    .animate-pulse-slow { animation: pulse 2s infinite; }

    .priority-1 { border-left: 3px solid #ef4444; }
    .priority-2 { border-left: 3px solid #f97316; }
    .priority-3 { border-left: 3px solid #eab308; }
    .priority-4 { border-left: 3px solid #3b82f6; }
    .priority-5 { border-left: 3px solid #6b7280; }

    .glass { background: rgba(22, 33, 62, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.06); }
    .glass-hover:hover { background: rgba(22, 33, 62, 0.8); border-color: rgba(255,255,255,0.12); }

    .status-glow { box-shadow: 0 0 20px -5px currentColor; }
    .btn-amber { background: linear-gradient(135deg, #f6b93b, #e58e26); color: #0a0a1a; font-weight: 600; }
    .btn-amber:hover { background: linear-gradient(135deg, #f9c74f, #f6b93b); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(246,185,59,0.3); }
    .btn-amber:active { transform: translateY(0); }

    .modal-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }

    input, textarea, select {
      background: #1a1a2e;
      border: 1px solid rgba(255,255,255,0.1);
      color: #e2e8f0;
      border-radius: 6px;
      padding: 10px 14px;
      font-size: 14px;
      font-family: 'DM Sans', sans-serif;
      transition: border-color 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #f6b93b;
      box-shadow: 0 0 0 3px rgba(246,185,59,0.15);
    }
    select option { background: #1a1a2e; }

    /* Portfolio chart styles */
    .sparkline { fill: none; stroke: #f6b93b; stroke-width: 2; }
    .sparkline-area { fill: url(#sparkGrad); opacity: 0.3; }

    /* Chat bubble styles */
    .bubble-user { background: rgba(246, 185, 59, 0.15); border: 1px solid rgba(246, 185, 59, 0.2); border-radius: 16px 16px 4px 16px; }
    .bubble-bot { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.15); border-radius: 16px 16px 16px 4px; }

    /* Tab active indicator */
    .tab-active { border-bottom: 2px solid #f6b93b; color: #f6b93b; }
    .tab-inactive { border-bottom: 2px solid transparent; color: #94a3b8; }
    .tab-inactive:hover { color: #e2e8f0; border-color: rgba(255,255,255,0.1); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;

    // ============================================
    // Supabase Connection
    // ============================================
    // ============================================
    // Supabase Client (hardcoded ‚Äî safe with RLS + Auth)
    // ============================================
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';        // e.g. https://xxxx.supabase.co
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // e.g. eyJhbGciOiJIUzI1NiIs...

    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function signInWithGoogle() {
      const { error } = await db.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.origin + window.location.pathname,
        },
      });
      if (error) throw error;
    }

    async function signOut() {
      await db.auth.signOut();
    }

    // ============================================
    // Constants
    // ============================================
    const STATUSES = ['backlog', 'todo', 'in_progress', 'review', 'done'];
    const STATUS_CONFIG = {
      backlog:     { label: 'Backlog',     emoji: 'üì¶', color: '#6b7280', bg: 'rgba(107,114,128,0.1)' },
      todo:        { label: 'To Do',       emoji: 'üìã', color: '#eab308', bg: 'rgba(234,179,8,0.1)' },
      in_progress: { label: 'In Progress', emoji: 'üî®', color: '#3b82f6', bg: 'rgba(59,130,246,0.1)' },
      review:      { label: 'Review',      emoji: 'üîç', color: '#a855f7', bg: 'rgba(168,85,247,0.1)' },
      done:        { label: 'Done',        emoji: '‚úÖ', color: '#22c55e', bg: 'rgba(34,197,94,0.1)' },
    };
    const PRIORITY_CONFIG = {
      1: { label: 'Critical', color: '#ef4444', icon: 'üî¥' },
      2: { label: 'High',     color: '#f97316', icon: 'üü†' },
      3: { label: 'Medium',   color: '#eab308', icon: 'üü°' },
      4: { label: 'Low',      color: '#3b82f6', icon: 'üîµ' },
      5: { label: 'Minimal',  color: '#6b7280', icon: '‚ö™' },
    };
    const ASSIGNEE_PRESETS = {
      'claude':  { label: 'ü§ñ Claude', color: '#a855f7' },
      'sparky':  { label: '‚ö° Sparky', color: '#f6b93b' },
      'both':    { label: 'ü§ù Both',   color: '#3b82f6' },
    };

    function getAssigneeDisplay(assignedTo) {
      if (!assignedTo) return null;
      const preset = ASSIGNEE_PRESETS[assignedTo];
      if (preset) return preset;
      return { label: `üë§ ${assignedTo}`, color: '#94a3b8' };
    }


    function timeAgo(date) {
      const now = new Date();
      const d = new Date(date);
      const seconds = Math.floor((now - d) / 1000);
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return minutes + 'm ago';
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return hours + 'h ago';
      const days = Math.floor(hours / 24);
      if (days < 7) return days + 'd ago';
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // ============================================
    // Login Screen (Google OAuth)
    // ============================================
    function LoginScreen() {
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleGoogleLogin = async () => {
        setLoading(true);
        setError('');
        try {
          await signInWithGoogle();
        } catch (e) {
          setError(e.message || 'Failed to sign in with Google');
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-8">
          <div className="glass rounded-2xl p-10 max-w-md w-full animate-fade">
            <div className="text-center mb-8">
              <div className="text-5xl mb-3">‚ö°</div>
              <h1 className="text-2xl font-bold font-mono tracking-tight">SparkyBot Command Center</h1>
              <p className="text-sm text-gray-400 mt-2">Sign in to access your dashboard</p>
            </div>

            {error && <div className="text-red-400 text-sm bg-red-400/10 rounded-lg p-3 mb-5">{error}</div>}

            <button
              onClick={handleGoogleLogin}
              disabled={loading}
              className="w-full py-3.5 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-3"
              style={{ background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.12)' }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              {loading ? 'Redirecting...' : 'Sign in with Google'}
            </button>

            <p className="text-xs text-gray-500 mt-6 text-center">
              Access is restricted to authorized accounts only.
            </p>
          </div>
        </div>
      );
    }

    // ============================================
    // Card Component
    // ============================================
    function KanbanCard({ card, onEdit, onMove, onDelete, onSync }) {
      const [dragging, setDragging] = useState(false);

      const handleDragStart = (e) => {
        setDragging(true);
        e.dataTransfer.setData('text/plain', JSON.stringify({ id: card.id, status: card.status }));
        e.dataTransfer.effectAllowed = 'move';
      };

      const handleDragEnd = () => setDragging(false);

      const assignee = getAssigneeDisplay(card.assigned_to);

      return (
        <div
          draggable
          onDragStart={handleDragStart}
          onDragEnd={handleDragEnd}
          className={`glass glass-hover rounded-lg p-4 mb-3 cursor-grab active:cursor-grabbing transition-all animate-slide priority-${card.priority} ${dragging ? 'card-drag' : ''}`}
        >
          <div className="flex items-start justify-between gap-2 mb-2">
            <h3 className="text-sm font-semibold leading-snug flex-1">
              {card.is_anomaly && <span className="text-amber-400 mr-1">‚ö†Ô∏è</span>}
              {card.title}
            </h3>
          </div>

          <div className="flex items-center gap-2 flex-wrap">
            <span className="text-xs px-2 py-0.5 rounded-full font-mono" style={{
              background: `${PRIORITY_CONFIG[card.priority]?.color}20`,
              color: PRIORITY_CONFIG[card.priority]?.color
            }}>
              {PRIORITY_CONFIG[card.priority]?.icon} {PRIORITY_CONFIG[card.priority]?.label}
            </span>

            {card.project_name && (
              <span className="text-xs text-gray-400 font-mono">{card.project_name}</span>
            )}

            {assignee && (
              <span className="text-xs px-2 py-0.5 rounded-full font-mono" style={{
                background: `${assignee.color}20`,
                color: assignee.color
              }}>
                {assignee.label}
              </span>
            )}
          </div>

          {card.github_issue_url && (
            <a href={card.github_issue_url} target="_blank" rel="noopener"
              className="text-xs text-blue-400 hover:text-blue-300 mt-2 inline-flex items-center gap-1 font-mono">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
              #{card.github_issue_id}
            </a>
          )}

          <div className="flex items-center justify-between mt-3 pt-3 border-t border-white/5">
            <code className="text-[10px] text-gray-500 font-mono">{card.id?.substring(0, 8)}</code>
            <div className="flex gap-1">
              {!card.github_issue_url && (
                <button onClick={() => onSync(card)} className="text-xs text-gray-500 hover:text-blue-400 transition-colors px-1.5 py-0.5 rounded hover:bg-blue-400/10" title="Sync to GitHub">
                  üîó
                </button>
              )}
              <button onClick={() => onDelete(card)} className="text-xs text-gray-500 hover:text-red-400 transition-colors px-1.5 py-0.5 rounded hover:bg-red-400/10" title="Delete">
                üóëÔ∏è
              </button>
              <button onClick={() => onEdit(card)} className="text-xs text-gray-500 hover:text-amber-400 transition-colors px-1.5 py-0.5 rounded hover:bg-amber-400/10" title="Edit">
                ‚úèÔ∏è
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // Column Component
    // ============================================
    function KanbanColumn({ status, cards, onDrop, onEdit, onDelete, onSync }) {
      const [dragOver, setDragOver] = useState(false);
      const config = STATUS_CONFIG[status];

      const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; setDragOver(true); };
      const handleDragLeave = () => setDragOver(false);
      const handleDrop = (e) => {
        e.preventDefault();
        setDragOver(false);
        try {
          const data = JSON.parse(e.dataTransfer.getData('text/plain'));
          if (data.status !== status) onDrop(data.id, status);
        } catch {}
      };

      return (
        <div
          className={`kanban-column rounded-xl p-3 transition-all ${dragOver ? 'drop-target' : ''}`}
          style={{ background: config.bg, minWidth: '250px', flex: '1 1 250px' }}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
          onDrop={handleDrop}
        >
          <div className="flex items-center justify-between mb-4 px-1">
            <div className="flex items-center gap-2">
              <span className="text-lg">{config.emoji}</span>
              <h2 className="text-sm font-bold font-mono uppercase tracking-wider" style={{ color: config.color }}>
                {config.label}
              </h2>
            </div>
            <span className="text-xs font-mono px-2 py-0.5 rounded-full" style={{
              background: `${config.color}20`, color: config.color
            }}>
              {cards.length}
            </span>
          </div>

          <div className="space-y-0">
            {cards.map(card => (
              <KanbanCard key={card.id} card={card} onEdit={onEdit} onMove={onDrop} onDelete={onDelete} onSync={onSync} />
            ))}
            {cards.length === 0 && (
              <div className="text-center py-8 text-gray-600 text-xs font-mono">
                Drop cards here
              </div>
            )}
          </div>
        </div>
      );
    }

    // ============================================
    // Card Modal (Create/Edit) ‚Äî with Assignee
    // ============================================
    function CardModal({ card, projects, onSave, onClose }) {
      const [title, setTitle] = useState(card?.title || '');
      const [description, setDescription] = useState(card?.description || '');
      const [status, setStatus] = useState(card?.status || 'todo');
      const [priority, setPriority] = useState(card?.priority || 3);
      const [projectId, setProjectId] = useState(card?.project_id || (projects[0]?.id || ''));
      const [assignee, setAssignee] = useState(card?.assigned_to || '');
      const [customAssignee, setCustomAssignee] = useState('');
      const [showCustom, setShowCustom] = useState(false);
      const [saving, setSaving] = useState(false);

      // If card has a custom assignee (not in presets), show in custom field
      useEffect(() => {
        if (card?.assigned_to && !ASSIGNEE_PRESETS[card.assigned_to]) {
          setAssignee('custom');
          setCustomAssignee(card.assigned_to);
          setShowCustom(true);
        }
      }, [card]);

      const handleAssigneeChange = (val) => {
        setAssignee(val);
        if (val === 'custom') {
          setShowCustom(true);
        } else {
          setShowCustom(false);
          setCustomAssignee('');
        }
      };

      const handleSave = async () => {
        if (!title.trim()) return;
        setSaving(true);
        const resolvedAssignee = assignee === 'custom' ? customAssignee.trim().toLowerCase() : (assignee || null);
        await onSave({
          id: card?.id,
          title: title.trim(),
          description: description.trim(),
          status,
          priority: parseInt(priority),
          project_id: projectId,
          assigned_to: resolvedAssignee || null,
        });
        setSaving(false);
        onClose();
      };

      return (
        <div className="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4" onClick={onClose}>
          <div className="glass rounded-2xl p-6 w-full max-w-lg animate-fade" onClick={e => e.stopPropagation()}>
            <h2 className="text-lg font-bold font-mono mb-5">
              {card ? 'Edit Task' : 'New Task'}
            </h2>

            <div className="space-y-4">
              <div>
                <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">Title</label>
                <input value={title} onChange={e => setTitle(e.target.value)} placeholder="Task title..." className="w-full" autoFocus />
              </div>

              <div>
                <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">Description</label>
                <textarea value={description} onChange={e => setDescription(e.target.value)} placeholder="Optional details..." className="w-full h-24 resize-none" />
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">Status</label>
                  <select value={status} onChange={e => setStatus(e.target.value)} className="w-full text-sm">
                    {STATUSES.map(s => <option key={s} value={s}>{STATUS_CONFIG[s].emoji} {STATUS_CONFIG[s].label}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">Priority</label>
                  <select value={priority} onChange={e => setPriority(e.target.value)} className="w-full text-sm">
                    {[1,2,3,4,5].map(p => <option key={p} value={p}>{PRIORITY_CONFIG[p].icon} {PRIORITY_CONFIG[p].label}</option>)}
                  </select>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">Project</label>
                  <select value={projectId} onChange={e => setProjectId(e.target.value)} className="w-full text-sm">
                    {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">Assignee</label>
                  <select value={assignee} onChange={e => handleAssigneeChange(e.target.value)} className="w-full text-sm">
                    <option value="">Unassigned</option>
                    {Object.entries(ASSIGNEE_PRESETS).map(([key, val]) => (
                      <option key={key} value={key}>{val.label}</option>
                    ))}
                    <option value="custom">‚úèÔ∏è Custom...</option>
                  </select>
                </div>
              </div>

              {showCustom && (
                <div className="animate-fade">
                  <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">Custom Assignee Name</label>
                  <input
                    value={customAssignee}
                    onChange={e => setCustomAssignee(e.target.value)}
                    placeholder="Enter name..."
                    className="w-full text-sm"
                    autoFocus
                  />
                </div>
              )}
            </div>

            <div className="flex gap-3 mt-6">
              <button onClick={onClose} className="flex-1 py-2.5 rounded-lg text-sm font-mono text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                Cancel
              </button>
              <button onClick={handleSave} disabled={saving || !title.trim()} className="flex-1 btn-amber py-2.5 rounded-lg text-sm font-mono transition-all disabled:opacity-50">
                {saving ? 'Saving...' : card ? 'Update' : 'Create'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // Anomaly Panel
    // ============================================
    function AnomalyPanel({ anomalies }) {
      if (anomalies.length === 0) {
        return (
          <div className="glass rounded-xl p-4 animate-fade">
            <div className="flex items-center gap-2 mb-2">
              <span className="text-lg">‚úÖ</span>
              <h3 className="text-sm font-bold font-mono">System Health</h3>
            </div>
            <p className="text-xs text-green-400 font-mono">All systems healthy ‚Äî no open anomalies</p>
          </div>
        );
      }

      const bySkill = {};
      anomalies.forEach(a => {
        const skill = a.anomaly_details?.skillId || 'unknown';
        bySkill[skill] = (bySkill[skill] || 0) + 1;
      });

      return (
        <div className="glass rounded-xl p-4 animate-fade border-l-2 border-amber-400">
          <div className="flex items-center gap-2 mb-3">
            <span className="text-lg animate-pulse-slow">‚ö†Ô∏è</span>
            <h3 className="text-sm font-bold font-mono text-amber-400">
              {anomalies.length} Open Anomal{anomalies.length === 1 ? 'y' : 'ies'}
            </h3>
          </div>
          <div className="space-y-2">
            {Object.entries(bySkill).map(([skill, count]) => (
              <div key={skill} className="flex items-center justify-between text-xs font-mono">
                <span className="text-gray-400">{skill}</span>
                <span className="text-amber-400 bg-amber-400/10 px-2 py-0.5 rounded-full">{count}</span>
              </div>
            ))}
          </div>
          <div className="mt-3 pt-3 border-t border-white/5 space-y-1.5">
            {anomalies.slice(0, 5).map(a => (
              <div key={a.id} className="text-xs text-gray-400 truncate">
                {PRIORITY_CONFIG[a.priority]?.icon} {a.title.substring(0, 60)}
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ============================================
    // Stats Bar
    // ============================================
    function StatsBar({ cards, projects }) {
      const total = cards.length;
      const inProgress = cards.filter(c => c.status === 'in_progress').length;
      const anomalies = cards.filter(c => c.is_anomaly && c.status !== 'done').length;
      const doneThisWeek = cards.filter(c => {
        if (c.status !== 'done') return false;
        const updated = new Date(c.updated_at);
        const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
        return updated > weekAgo;
      }).length;

      const stats = [
        { label: 'Active', value: total - cards.filter(c => c.status === 'done').length, color: '#f6b93b' },
        { label: 'In Progress', value: inProgress, color: '#3b82f6' },
        { label: 'Done (7d)', value: doneThisWeek, color: '#22c55e' },
        { label: 'Anomalies', value: anomalies, color: anomalies > 0 ? '#ef4444' : '#22c55e' },
        { label: 'Projects', value: projects.length, color: '#a855f7' },
      ];

      return (
        <div className="flex gap-4 overflow-x-auto pb-2">
          {stats.map(s => (
            <div key={s.label} className="glass rounded-lg px-4 py-3 min-w-[120px]">
              <div className="text-2xl font-bold font-mono" style={{ color: s.color }}>{s.value}</div>
              <div className="text-[10px] font-mono text-gray-500 uppercase tracking-wider mt-0.5">{s.label}</div>
            </div>
          ))}
        </div>
      );
    }


    // ============================================
    // Portfolio Tab
    // ============================================
    function PortfolioTab() {
      const [snapshots, setSnapshots] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        async function load() {
          const { data } = await db.from('portfolio_snapshots').select('*').order('snapshot_date', { ascending: false }).limit(30);
          setSnapshots(data || []);
          setLoading(false);
        }
        load();
      }, [db]);

      if (loading) return <div className="text-center py-12 text-gray-500 font-mono text-sm animate-pulse-slow">Loading portfolio...</div>;
      if (snapshots.length === 0) return (
        <div className="glass rounded-xl p-8 text-center animate-fade">
          <div className="text-3xl mb-3">üìä</div>
          <p className="text-gray-400 font-mono text-sm">No portfolio snapshots yet.</p>
          <p className="text-gray-600 text-xs mt-2">Snapshots are taken daily with the overnight analysis.</p>
        </div>
      );

      const latest = snapshots[0];
      const holdings = latest.holdings || [];
      const history = [...snapshots].reverse();
      const maxVal = Math.max(...history.map(s => Number(s.total_value) || 0));
      const minVal = Math.min(...history.map(s => Number(s.total_value) || 0));
      const range = maxVal - minVal || 1;

      return (
        <div className="space-y-6 animate-fade">
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div className="glass rounded-xl p-5">
              <div className="text-xs font-mono text-gray-500 uppercase tracking-wider mb-1">Total Value</div>
              <div className="text-2xl font-bold font-mono text-amber-400">
                {'$' + Number(latest.total_value || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}
              </div>
              <div className="text-xs font-mono mt-1" style={{ color: latest.daily_change_pct >= 0 ? '#22c55e' : '#ef4444' }}>
                {latest.daily_change_pct >= 0 ? '‚ñ≤' : '‚ñº'} {'$' + Math.abs(Number(latest.daily_change || 0)).toLocaleString('en-US', { minimumFractionDigits: 2 })} ({latest.daily_change_pct >= 0 ? '+' : ''}{latest.daily_change_pct}%)
              </div>
            </div>
            <div className="glass rounded-xl p-5">
              <div className="text-xs font-mono text-gray-500 uppercase tracking-wider mb-1">Holdings</div>
              <div className="text-2xl font-bold font-mono text-blue-400">{Array.isArray(holdings) ? holdings.length : '‚Äî'}</div>
              <div className="text-xs text-gray-500 mt-1">positions tracked</div>
            </div>
            <div className="glass rounded-xl p-5">
              <div className="text-xs font-mono text-gray-500 uppercase tracking-wider mb-1">History</div>
              <div className="text-2xl font-bold font-mono text-purple-400">{snapshots.length}</div>
              <div className="text-xs text-gray-500 mt-1">daily snapshots</div>
            </div>
          </div>

          {history.length > 1 && (
            <div className="glass rounded-xl p-5">
              <div className="text-xs font-mono text-gray-500 uppercase tracking-wider mb-4">Portfolio Value ‚Äî Last {history.length} Days</div>
              <div className="relative h-48">
                <svg viewBox={'0 0 ' + (history.length * 30) + ' 200'} className="w-full h-full" preserveAspectRatio="none">
                  <defs>
                    <linearGradient id="sparkGrad" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="0%" stopColor="#f6b93b" stopOpacity="0.3"/>
                      <stop offset="100%" stopColor="#f6b93b" stopOpacity="0"/>
                    </linearGradient>
                  </defs>
                  <path className="sparkline-area" d={
                    history.map((s, i) => {
                      const x = i * 30;
                      const y = 190 - ((Number(s.total_value || 0) - minVal) / range) * 170;
                      return (i === 0 ? 'M' : 'L') + x + ',' + y;
                    }).join(' ') + ' L' + ((history.length - 1) * 30) + ',190 L0,190 Z'
                  } />
                  <path className="sparkline" d={
                    history.map((s, i) => {
                      const x = i * 30;
                      const y = 190 - ((Number(s.total_value || 0) - minVal) / range) * 170;
                      return (i === 0 ? 'M' : 'L') + x + ',' + y;
                    }).join(' ')
                  } />
                  {history.map((s, i) => {
                    const x = i * 30;
                    const y = 190 - ((Number(s.total_value || 0) - minVal) / range) * 170;
                    return <circle key={i} cx={x} cy={y} r="3" fill="#f6b93b" opacity="0.6" />;
                  })}
                </svg>
                <div className="absolute top-0 right-0 text-[10px] font-mono text-gray-600">{'$' + maxVal.toLocaleString()}</div>
                <div className="absolute bottom-0 right-0 text-[10px] font-mono text-gray-600">{'$' + minVal.toLocaleString()}</div>
              </div>
              <div className="flex justify-between mt-2">
                <span className="text-[10px] font-mono text-gray-600">{new Date(history[0] && history[0].snapshot_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                <span className="text-[10px] font-mono text-gray-600">{new Date(history[history.length-1] && history[history.length-1].snapshot_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
              </div>
            </div>
          )}

          {Array.isArray(holdings) && holdings.length > 0 && (
            <div className="glass rounded-xl p-5">
              <div className="text-xs font-mono text-gray-500 uppercase tracking-wider mb-4">Holdings ‚Äî {new Date(latest.snapshot_date).toLocaleDateString()}</div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="text-xs font-mono text-gray-500 uppercase border-b border-white/5">
                      <th className="text-left py-2 pr-4">Symbol</th>
                      <th className="text-right py-2 px-4">Shares</th>
                      <th className="text-right py-2 px-4">Price</th>
                      <th className="text-right py-2 px-4">Value</th>
                      <th className="text-right py-2 pl-4">Change</th>
                    </tr>
                  </thead>
                  <tbody>
                    {holdings.map((h, i) => (
                      <tr key={i} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                        <td className="py-2.5 pr-4 font-mono font-semibold text-amber-400">{h.symbol}</td>
                        <td className="py-2.5 px-4 text-right font-mono text-gray-300">{h.shares || h.quantity || '‚Äî'}</td>
                        <td className="py-2.5 px-4 text-right font-mono text-gray-300">{'$' + Number(h.price || h.currentPrice || 0).toFixed(2)}</td>
                        <td className="py-2.5 px-4 text-right font-mono text-gray-300">{'$' + Number(h.value || h.totalValue || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                        <td className="py-2.5 pl-4 text-right font-mono" style={{ color: Number(h.changePct || h.change_pct || 0) >= 0 ? '#22c55e' : '#ef4444' }}>
                          {Number(h.changePct || h.change_pct || 0) >= 0 ? '+' : ''}{Number(h.changePct || h.change_pct || 0).toFixed(2)}%
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ============================================
    // Conversations Tab
    // ============================================
    function ConversationsTab() {
      const [messages, setMessages] = useState([]);
      const [loading, setLoading] = useState(true);
      const [page, setPage] = useState(0);
      const [hasMore, setHasMore] = useState(true);
      const [filterSkill, setFilterSkill] = useState('all');
      const PAGE_SIZE = 50;

      const fetchMessages = useCallback(async (pageNum) => {
        setLoading(true);
        const from = (pageNum || 0) * PAGE_SIZE;
        const { data, error } = await db.from('conversations')
          .select('*')
          .order('created_at', { ascending: false })
          .range(from, from + PAGE_SIZE - 1);
        if (!error && data) {
          if (!pageNum) setMessages(data);
          else setMessages(prev => [...prev, ...data]);
          setHasMore(data.length === PAGE_SIZE);
        }
        setLoading(false);
      }, [db]);

      useEffect(() => { fetchMessages(0); }, [fetchMessages]);

      const skills = useMemo(() => {
        const s = new Set();
        messages.forEach(m => { if (m.skill_used) s.add(m.skill_used); });
        return [...s].sort();
      }, [messages]);

      const filtered = filterSkill === 'all' ? messages : messages.filter(m => m.skill_used === filterSkill);

      // Group messages into conversation pairs (newest first from DB, display newest at bottom)
      const pairs = useMemo(() => {
        const result = [];
        for (let i = 0; i < filtered.length; i++) {
          const msg = filtered[i];
          if (msg.message_type === 'assistant' && i + 1 < filtered.length && filtered[i+1].message_type === 'user') {
            result.push({ user: filtered[i+1], bot: msg });
            i++;
          } else {
            result.push(msg.message_type === 'user' ? { user: msg, bot: null } : { user: null, bot: msg });
          }
        }
        return result.reverse();
      }, [filtered]);

      if (loading && messages.length === 0) return <div className="text-center py-12 text-gray-500 font-mono text-sm animate-pulse-slow">Loading conversations...</div>;

      return (
        <div className="animate-fade">
          <div className="flex items-center justify-between mb-4">
            <div className="text-xs font-mono text-gray-500">{messages.length} messages loaded</div>
            <select value={filterSkill} onChange={e => setFilterSkill(e.target.value)} className="text-xs font-mono py-1.5 px-2 rounded-lg">
              <option value="all">All Skills</option>
              {skills.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
          </div>

          {hasMore && (
            <div className="text-center mb-4">
              <button onClick={() => { const next = page + 1; setPage(next); fetchMessages(next); }}
                className="text-xs font-mono text-amber-400 hover:text-amber-300 px-4 py-2 rounded-lg glass glass-hover transition-all">
                Load older messages...
              </button>
            </div>
          )}

          <div className="space-y-4 max-w-3xl mx-auto">
            {pairs.map((pair, i) => (
              <div key={i} className="space-y-2 animate-slide">
                {pair.user && (
                  <div className="flex justify-end">
                    <div className="bubble-user px-4 py-3 max-w-[80%]">
                      <div className="text-sm whitespace-pre-wrap">{pair.user.message_text}</div>
                      <div className="text-[10px] font-mono text-gray-500 mt-1.5">{timeAgo(pair.user.created_at)}</div>
                    </div>
                  </div>
                )}
                {pair.bot && (
                  <div className="flex justify-start">
                    <div className="bubble-bot px-4 py-3 max-w-[80%]">
                      <div className="flex items-center gap-1.5 mb-1">
                        <span className="text-xs">‚ö°</span>
                        <span className="text-[10px] font-mono text-blue-400 uppercase tracking-wider">Sparky</span>
                        {pair.bot.skill_used && <span className="text-[10px] font-mono text-gray-600 ml-1">via {pair.bot.skill_used}</span>}
                      </div>
                      <div className="text-sm whitespace-pre-wrap text-gray-300">
                        {pair.bot.message_text && pair.bot.message_text.length > 500 ? pair.bot.message_text.substring(0, 500) + '...' : pair.bot.message_text}
                      </div>
                      <div className="text-[10px] font-mono text-gray-600 mt-1.5">{timeAgo(pair.bot.created_at)}</div>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>

          {messages.length === 0 && (
            <div className="glass rounded-xl p-8 text-center">
              <div className="text-3xl mb-3">üí¨</div>
              <p className="text-gray-400 font-mono text-sm">No conversations yet.</p>
            </div>
          )}
        </div>
      );
    }

    // ============================================
    // VIP Contacts Tab
    // ============================================
    function VIPModal({ contact, onSave, onClose }) {
      const [name, setName] = useState(contact ? contact.name : '');
      const [email, setEmail] = useState(contact ? contact.email || '' : '');
      const [phone, setPhone] = useState(contact ? contact.phone || '' : '');
      const [twitter, setTwitter] = useState(contact ? contact.twitter_handle || '' : '');
      const [priority, setPriority] = useState(contact ? contact.priority || 1 : 1);
      const [notes, setNotes] = useState(contact ? contact.notes || '' : '');

      return (
        <div className="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4" onClick={onClose}>
          <div className="glass rounded-2xl p-6 w-full max-w-md animate-fade" onClick={e => e.stopPropagation()}>
            <h2 className="text-lg font-bold font-mono mb-5">{contact ? 'Edit VIP' : 'New VIP Contact'}</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">Name *</label>
                <input value={name} onChange={e => setName(e.target.value)} placeholder="Full name" className="w-full" autoFocus />
              </div>
              <div>
                <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">Email</label>
                <input value={email} onChange={e => setEmail(e.target.value)} placeholder="email@example.com" className="w-full" />
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">Phone</label>
                  <input value={phone} onChange={e => setPhone(e.target.value)} placeholder="+1 555-0000" className="w-full" />
                </div>
                <div>
                  <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">X / Twitter</label>
                  <input value={twitter} onChange={e => setTwitter(e.target.value)} placeholder="@handle" className="w-full" />
                </div>
              </div>
              <div>
                <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">Priority (1=highest)</label>
                <select value={priority} onChange={e => setPriority(parseInt(e.target.value))} className="w-full text-sm">
                  <option value="1">‚òÖ Priority 1</option>
                  <option value="2">‚òÖ‚òÖ Priority 2</option>
                  <option value="3">‚òÖ‚òÖ‚òÖ Priority 3</option>
                  <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ Priority 4</option>
                  <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Priority 5</option>
                </select>
              </div>
              <div>
                <label className="block text-xs font-mono text-gray-400 mb-1.5 uppercase tracking-wider">Notes</label>
                <textarea value={notes} onChange={e => setNotes(e.target.value)} placeholder="Relationship notes..." className="w-full h-20 resize-none" />
              </div>
            </div>
            <div className="flex gap-3 mt-6">
              <button onClick={onClose} className="flex-1 py-2.5 rounded-lg text-sm font-mono text-gray-400 hover:text-white hover:bg-white/5 transition-all">Cancel</button>
              <button onClick={() => onSave({ id: contact && contact.id, name: name, email: email || null, phone: phone || null, twitter_handle: twitter || null, priority: priority, notes: notes || null })} disabled={!name.trim()} className="flex-1 btn-amber py-2.5 rounded-lg text-sm font-mono transition-all disabled:opacity-50">
                {contact ? 'Update' : 'Add VIP'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    function VIPContactsTab() {
      const [contacts, setContacts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [editing, setEditing] = useState(null); // null=closed, {}=new, contact=edit

      const fetchContacts = useCallback(async () => {
        const { data } = await db.from('vip_contacts').select('*').order('priority', { ascending: true }).order('name');
        setContacts(data || []);
        setLoading(false);
      }, [db]);

      useEffect(() => { fetchContacts(); }, [fetchContacts]);

      const handleSave = async (contact) => {
        if (contact.id) {
          await db.from('vip_contacts').update({
            name: contact.name, email: contact.email, phone: contact.phone,
            twitter_handle: contact.twitter_handle, priority: contact.priority, notes: contact.notes,
            updated_at: new Date().toISOString(),
          }).eq('id', contact.id);
        } else {
          await db.from('vip_contacts').insert({
            name: contact.name, email: contact.email, phone: contact.phone,
            twitter_handle: contact.twitter_handle, priority: contact.priority, notes: contact.notes,
          });
        }
        setEditing(null);
        fetchContacts();
      };

      const handleDelete = async (id) => {
        if (!confirm('Delete this VIP contact?')) return;
        await db.from('vip_contacts').delete().eq('id', id);
        fetchContacts();
      };

      if (loading) return <div className="text-center py-12 text-gray-500 font-mono text-sm animate-pulse-slow">Loading VIP contacts...</div>;

      return (
        <div className="animate-fade">
          <div className="flex items-center justify-between mb-4">
            <div className="text-xs font-mono text-gray-500">{contacts.length} VIP contact{contacts.length !== 1 ? 's' : ''}</div>
            <button onClick={() => setEditing({})} className="btn-amber px-4 py-1.5 rounded-lg text-xs font-mono transition-all">+ Add VIP</button>
          </div>

          {contacts.length === 0 ? (
            <div className="glass rounded-xl p-8 text-center">
              <div className="text-3xl mb-3">üëë</div>
              <p className="text-gray-400 font-mono text-sm">No VIP contacts yet.</p>
              <p className="text-gray-600 text-xs mt-2">VIPs get priority email alerts and mentions.</p>
            </div>
          ) : (
            <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
              {contacts.map(c => (
                <div key={c.id} className="glass glass-hover rounded-xl p-4 animate-slide">
                  <div className="flex items-start justify-between gap-2 mb-2">
                    <div>
                      <h3 className="text-sm font-semibold flex items-center gap-1.5">
                        {c.suggested_by_bot && !c.confirmed && <span className="text-amber-400" title="Bot suggestion">üí°</span>}
                        {c.name}
                      </h3>
                      <div className="flex items-center gap-0.5 mt-0.5">
                        {[1,2,3,4,5].map(i => (
                          <span key={i} className={'text-[10px] ' + (i <= (c.priority || 1) ? 'text-amber-400' : 'text-gray-700')}>‚òÖ</span>
                        ))}
                      </div>
                    </div>
                    <div className="flex gap-1">
                      <button onClick={() => setEditing(c)} className="text-xs text-gray-500 hover:text-amber-400 transition-colors px-1.5 py-0.5 rounded hover:bg-amber-400/10">‚úèÔ∏è</button>
                      <button onClick={() => handleDelete(c.id)} className="text-xs text-gray-500 hover:text-red-400 transition-colors px-1.5 py-0.5 rounded hover:bg-red-400/10">üóëÔ∏è</button>
                    </div>
                  </div>
                  <div className="space-y-1 text-xs font-mono text-gray-400">
                    {c.email && <div className="flex items-center gap-1.5"><span className="text-gray-600">üìß</span> {c.email}</div>}
                    {c.phone && <div className="flex items-center gap-1.5"><span className="text-gray-600">üì±</span> {c.phone}</div>}
                    {c.twitter_handle && <div className="flex items-center gap-1.5"><span className="text-gray-600">ùïè</span> @{c.twitter_handle.replace('@','')}</div>}
                    {c.notes && <div className="text-gray-500 mt-2 italic text-[11px]">{c.notes}</div>}
                  </div>
                </div>
              ))}
            </div>
          )}

          {editing !== null && (
            <VIPModal contact={editing.id ? editing : null} onSave={handleSave} onClose={() => setEditing(null)} />
          )}
        </div>
      );
    }

    // ============================================
    // Confirm Dialog
    // ============================================
    function ConfirmDialog({ title, message, onConfirm, onCancel }) {
      return (
        <div className="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4" onClick={onCancel}>
          <div className="glass rounded-2xl p-6 w-full max-w-sm animate-fade" onClick={e => e.stopPropagation()}>
            <h2 className="text-lg font-bold font-mono mb-2">{title}</h2>
            <p className="text-sm text-gray-400 mb-5">{message}</p>
            <div className="flex gap-3">
              <button onClick={onCancel} className="flex-1 py-2.5 rounded-lg text-sm font-mono text-gray-400 hover:text-white hover:bg-white/5 transition-all">Cancel</button>
              <button onClick={onConfirm} className="flex-1 py-2.5 rounded-lg text-sm font-mono bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-all">Delete</button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // Toast Notification
    // ============================================
    function Toast({ message, type, onDismiss }) {
      useEffect(() => {
        const timer = setTimeout(onDismiss, 3000);
        return () => clearTimeout(timer);
      }, []);

      const colors = {
        success: 'bg-green-500/20 text-green-400 border-green-500/30',
        error: 'bg-red-500/20 text-red-400 border-red-500/30',
        info: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
      };

      return (
        <div className={`fixed bottom-6 right-6 z-50 ${colors[type]} border rounded-lg px-4 py-3 text-sm font-mono animate-fade shadow-xl`}>
          {message}
        </div>
      );
    }

    // ============================================
    // Main Dashboard
    // ============================================
    function Dashboard({ user }) {
      const [cards, setCards] = useState([]);
      const [projects, setProjects] = useState([]);
      const [loading, setLoading] = useState(true);
      const [filterProject, setFilterProject] = useState('all');
      const [showDone, setShowDone] = useState(false);
      const [modalCard, setModalCard] = useState(undefined); // undefined=closed, null=new, card=edit
      const [confirmDelete, setConfirmDelete] = useState(null);
      const [toast, setToast] = useState(null);
      const [tab, setTab] = useState('board'); // board | portfolio | conversations | vip | anomalies

      const showToast = (message, type = 'success') => setToast({ message, type });

      const [snapshots, setSnapshots] = useState([]);
      const [vipContacts, setVipContacts] = useState([]);

      const fetchData = useCallback(async () => {
        try {
          const [cardsRes, projectsRes, snapshotsRes, vipRes] = await Promise.all([
            db.from('kanban_cards').select('*, projects(name)').order('priority', { ascending: true }).order('created_at', { ascending: false }),
            db.from('projects').select('*').neq('status', 'archived').order('name'),
            db.from('portfolio_snapshots').select('*').order('snapshot_date', { ascending: false }).limit(1),
            db.from('vip_contacts').select('id'),
          ]);
          if (cardsRes.error) throw cardsRes.error;

          const mappedCards = (cardsRes.data || []).map(c => ({
            ...c,
            project_name: c.projects?.name || projectsRes.data?.find(p => p.id === c.project_id)?.name || ''
          }));

          setCards(mappedCards);
          setProjects(projectsRes.data || []);
          setSnapshots(snapshotsRes.data || []);
          setVipContacts(vipRes.data || []);
        } catch (e) {
          console.error('Fetch error:', e);
          showToast(`Failed to load data: ${e.message}`, 'error');
        }
        setLoading(false);
      }, [db]);

      useEffect(() => { fetchData(); }, [fetchData]);

      // Auto-refresh every 30 seconds
      useEffect(() => {
        const interval = setInterval(fetchData, 30000);
        return () => clearInterval(interval);
      }, [fetchData]);

      const handleDrop = async (cardId, newStatus) => {
        setCards(prev => prev.map(c => c.id === cardId ? { ...c, status: newStatus } : c));
        try {
          const { error } = await db.from('kanban_cards').update({ status: newStatus, updated_at: new Date().toISOString() }).eq('id', cardId);
          if (error) throw error;
          showToast(`Moved to ${STATUS_CONFIG[newStatus].label}`);
        } catch (e) {
          showToast(`Move failed: ${e.message}`, 'error');
          fetchData();
        }
      };

      const handleSave = async (cardData) => {
        try {
          if (cardData.id) {
            const { error } = await db.from('kanban_cards').update({
              title: cardData.title,
              description: cardData.description,
              status: cardData.status,
              priority: cardData.priority,
              project_id: cardData.project_id,
              assigned_to: cardData.assigned_to,
              updated_at: new Date().toISOString(),
            }).eq('id', cardData.id);
            if (error) throw error;
            showToast('Task updated');
          } else {
            const insert = {
              title: cardData.title,
              description: cardData.description,
              status: cardData.status,
              priority: cardData.priority,
              project_id: cardData.project_id,
              is_anomaly: false,
            };
            if (cardData.assigned_to) insert.assigned_to = cardData.assigned_to;
            const { error } = await db.from('kanban_cards').insert(insert);
            if (error) throw error;
            showToast('Task created');
          }
          fetchData();
        } catch (e) {
          showToast(`Save failed: ${e.message}`, 'error');
        }
      };

      const handleDelete = async (card) => {
        try {
          const { error } = await db.from('kanban_cards').delete().eq('id', card.id);
          if (error) throw error;
          setCards(prev => prev.filter(c => c.id !== card.id));
          showToast('Task deleted');
        } catch (e) {
          showToast(`Delete failed: ${e.message}`, 'error');
        }
        setConfirmDelete(null);
      };

      const handleSync = async (card) => {
        showToast('Syncing to GitHub...', 'info');
        try {
          const ghToken = localStorage.getItem('gh_token');
          if (!ghToken) {
            const token = prompt('Enter your GitHub Personal Access Token (stored locally):');
            if (!token) return;
            localStorage.setItem('gh_token', token);
            await doGithubSync(card, token);
          } else {
            await doGithubSync(card, ghToken);
          }
        } catch (e) {
          showToast(`Sync failed: ${e.message}`, 'error');
        }
      };

      const doGithubSync = async (card, token) => {
        const project = projects.find(p => p.id === card.project_id);
        const repo = project?.github_repo || 'KDRSparky/sparkybot';
        const [owner, repoName] = repo.includes('/') ? repo.split('/') : ['KDRSparky', repo];

        const body = [
          card.description || '',
          '', '---',
          `_Synced from SparkyBot Dashboard_`,
          `**Status:** ${STATUS_CONFIG[card.status]?.emoji} ${STATUS_CONFIG[card.status]?.label}`,
          `**Priority:** ${PRIORITY_CONFIG[card.priority]?.icon} ${PRIORITY_CONFIG[card.priority]?.label}`,
          card.assigned_to ? `**Assigned To:** ${getAssigneeDisplay(card.assigned_to)?.label || card.assigned_to}` : '',
        ].filter(Boolean).join('\n');

        const labels = [card.status.replace('_', ' '), `P${card.priority}`];
        if (card.is_anomaly) labels.push('anomaly');
        if (card.assigned_to) labels.push(`assigned:${card.assigned_to}`);

        let issueUrl, issueNumber;
        if (card.github_issue_id) {
          const res = await fetch(`https://api.github.com/repos/${owner}/${repoName}/issues/${card.github_issue_id}`, {
            method: 'PATCH',
            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: card.title, body, state: card.status === 'done' ? 'closed' : 'open', labels }),
          });
          if (!res.ok) throw new Error(`GitHub ${res.status}`);
          const issue = await res.json();
          issueUrl = issue.html_url;
          issueNumber = issue.number;
        } else {
          const res = await fetch(`https://api.github.com/repos/${owner}/${repoName}/issues`, {
            method: 'POST',
            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: card.title, body, labels }),
          });
          if (!res.ok) throw new Error(`GitHub ${res.status}`);
          const issue = await res.json();
          issueUrl = issue.html_url;
          issueNumber = issue.number;
        }

        await db.from('kanban_cards').update({
          github_issue_id: issueNumber,
          github_issue_url: issueUrl,
          updated_at: new Date().toISOString(),
        }).eq('id', card.id);

        fetchData();
        showToast(`Synced to GitHub #${issueNumber}`);
      };

      const handleSignOut = async () => {
        await signOut();
      };

      let filteredCards = cards;
      if (filterProject !== 'all') {
        filteredCards = cards.filter(c => c.project_id === filterProject);
      }
      if (!showDone) {
        filteredCards = filteredCards.filter(c => c.status !== 'done');
      }

      const anomalies = cards.filter(c => c.is_anomaly && c.status !== 'done');
      const cardsByStatus = {};
      STATUSES.forEach(s => { cardsByStatus[s] = filteredCards.filter(c => c.status === s); });

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center animate-fade">
              <div className="text-4xl mb-3 animate-pulse-slow">‚ö°</div>
              <div className="text-sm font-mono text-gray-400">Loading command center...</div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen">
          <header className="sticky top-0 z-40 glass border-b border-white/5">
            <div className="max-w-[1800px] mx-auto px-4 sm:px-6 py-3">
              <div className="flex items-center justify-between flex-wrap gap-3">
                <div className="flex items-center gap-3">
                  <span className="text-2xl">‚ö°</span>
                  <div>
                    <h1 className="text-base font-bold font-mono tracking-tight">SparkyBot</h1>
                    <span className="text-[10px] font-mono text-gray-500 uppercase tracking-widest">Command Center</span>
                  </div>
                </div>

                <div className="flex items-center gap-3 flex-wrap">
                  {tab === 'board' && <select
                    value={filterProject}
                    onChange={e => setFilterProject(e.target.value)}
                    className="text-xs font-mono py-1.5 px-2 rounded-lg"
                  >
                    <option value="all">All Projects</option>
                    {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                  </select>

                  <label className="flex items-center gap-1.5 text-xs font-mono text-gray-400 cursor-pointer select-none">
                    <input type="checkbox" checked={showDone} onChange={e => setShowDone(e.target.checked)}
                      className="rounded border-gray-600 bg-transparent text-amber-400 focus:ring-amber-400/30" />
                    Done
                  </label>

                  <button onClick={() => setModalCard(null)} className="btn-amber px-4 py-1.5 rounded-lg text-xs font-mono transition-all">
                    + New Task
                  </button>

                  <button onClick={fetchData} className="text-gray-500 hover:text-amber-400 transition-colors p-1.5" title="Refresh">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
                  </button>

                  <button onClick={handleSignOut} className="text-gray-600 hover:text-red-400 transition-colors p-1.5 flex items-center gap-2" title="Sign Out">
                    {user?.user_metadata?.avatar_url && (
                      <img src={user.user_metadata.avatar_url} alt="" className="w-5 h-5 rounded-full" />
                    )}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                  </button>
                </div>
              </div>
            </div>

            {/* Tab Bar */}
            <div className="max-w-[1800px] mx-auto px-4 sm:px-6">
              <div className="flex gap-0 overflow-x-auto border-t border-white/5">
                {[
                  { id: 'board', label: 'Board', icon: 'üìã' },
                  { id: 'portfolio', label: 'Portfolio', icon: 'üìä' },
                  { id: 'conversations', label: 'Chat Log', icon: 'üí¨' },
                  { id: 'vip', label: 'VIP Contacts', icon: 'üëë' },
                  { id: 'anomalies', label: 'Anomalies', icon: '‚ö†Ô∏è', badge: anomalies.length || null },
                ].map(t => (
                  <button key={t.id} onClick={() => setTab(t.id)}
                    className={'px-4 py-2.5 text-xs font-mono transition-all whitespace-nowrap relative ' + (tab === t.id ? 'tab-active' : 'tab-inactive')}>
                    <span className="mr-1.5">{t.icon}</span>{t.label}
                    {t.badge > 0 && <span className="absolute -top-0.5 -right-0.5 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center">{t.badge}</span>}
                  </button>
                ))}
              </div>
            </div>
          </header>

          <div className="max-w-[1800px] mx-auto px-4 sm:px-6 pt-5 pb-3">
            <StatsBar cards={cards} projects={projects} snapshots={snapshots} vipContacts={vipContacts} />
          </div>

          <main className="max-w-[1800px] mx-auto px-4 sm:px-6 pb-8">
            {tab === 'board' && (
              <div className="flex gap-4 overflow-x-auto pt-3 pb-4">
                {STATUSES.filter(s => showDone || s !== 'done').map(status => (
                  <KanbanColumn key={status} status={status} cards={cardsByStatus[status] || []}
                    onDrop={handleDrop} onEdit={setModalCard} onDelete={setConfirmDelete} onSync={handleSync} />
                ))}
              </div>
            )}

            {tab === 'portfolio' && <div className="pt-4"><PortfolioTab /></div>}
            {tab === 'conversations' && <div className="pt-4"><ConversationsTab /></div>}
            {tab === 'vip' && <div className="pt-4"><VIPContactsTab /></div>}

            {tab === 'anomalies' && (
              <div className="max-w-2xl pt-4 space-y-4">
                <AnomalyPanel anomalies={anomalies} />
                {anomalies.map(a => (
                  <div key={a.id} className={'glass rounded-lg p-4 animate-slide priority-' + a.priority}>
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <h3 className="text-sm font-semibold">{a.title}</h3>
                        {a.anomaly_details && (
                          <div className="text-xs text-gray-500 font-mono mt-1.5 space-y-0.5">
                            <div>Skill: {a.anomaly_details.skillId}</div>
                            <div>Error: {a.anomaly_details.errorMessage ? a.anomaly_details.errorMessage.substring(0, 100) : ''}</div>
                            <div>Created: {new Date(a.anomaly_details.createdAt).toLocaleDateString()}</div>
                          </div>
                        )}
                      </div>
                      <span className="text-xs px-2 py-0.5 rounded-full shrink-0" style={{
                        background: (PRIORITY_CONFIG[a.priority] ? PRIORITY_CONFIG[a.priority].color : '#666') + '20',
                        color: PRIORITY_CONFIG[a.priority] ? PRIORITY_CONFIG[a.priority].color : '#666'
                      }}>
                        {PRIORITY_CONFIG[a.priority] ? PRIORITY_CONFIG[a.priority].label : 'Unknown'}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </main>

          {modalCard !== undefined && (
            <CardModal
              card={modalCard}
              projects={projects}
              onSave={handleSave}
              onClose={() => setModalCard(undefined)}
            />
          )}

          {confirmDelete && (
            <ConfirmDialog
              title="Delete Task"
              message={`Permanently delete "${confirmDelete.title}"?`}
              onConfirm={() => handleDelete(confirmDelete)}
              onCancel={() => setConfirmDelete(null)}
            />
          )}

          {toast && <Toast {...toast} onDismiss={() => setToast(null)} />}
        </div>
      );
    }

    // ============================================
    // App Root (Auth-aware)
    // ============================================
    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        // Check current session
        db.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user ?? null);
          setLoading(false);
        });

        // Listen for auth changes (login, logout, token refresh)
        const { data: { subscription } } = db.auth.onAuthStateChange((_event, session) => {
          setUser(session?.user ?? null);
          setLoading(false);
        });

        return () => subscription.unsubscribe();
      }, []);

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center animate-fade">
              <div className="text-4xl mb-3">‚ö°</div>
              <p className="text-gray-400 font-mono text-sm">Loading...</p>
            </div>
          </div>
        );
      }

      if (!user) return <LoginScreen />;
      return <Dashboard user={user} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>